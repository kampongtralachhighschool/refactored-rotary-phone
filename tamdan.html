<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធពិនិត្យលទ្ធផលសិក្សា - វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=Moul&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --khmer-red: #dc2626;
        }
        body { 
            font-family: 'Kantumruy Pro', sans-serif; 
            background: #f1f5f9;
            color: #1e293b;
        }
        .moul-font { font-family: 'Moul', serif; }
        .print-area {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 12mm 15mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .sketch-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            margin: 20px 0;
            padding: 12px 0;
            background: #ffffff;
        }
        .sketch-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .sketch-item:not(:last-child)::after {
            content: "";
            position: absolute;
            right: 0;
            top: 10%;
            height: 80%;
            width: 1px;
            background-color: #e2e8f0;
        }
        .sketch-label {
            font-size: 11px;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .sketch-value {
            font-size: 22px;
            font-weight: 800;
        }

        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 6px 4px; text-align: center; font-size: 12px; }
        th { background-color: #f8fafc; color: var(--primary-blue); font-weight: 700; height: 35px; }
        .subject-col { text-align: left; padding-left: 10px; font-weight: bold; font-size: 13px; width: 140px; }
        
        .progress-container {
            width: 100%;
            background-color: #f1f5f9;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .grade-A { color: #059669; }
        .grade-B { color: #2563eb; }
        .grade-C { color: #d97706; }
        .grade-D { color: #7c3aed; }
        .grade-E { color: #db2777; }
        .grade-F { color: #dc2626; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-area { box-shadow: none; margin: 0; padding: 10mm; width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Search Section (Home Page Header) -->
    <div class="max-w-4xl mx-auto my-6 no-print px-4">
        <div class="text-center mb-6 space-y-2">
            <h2 class="moul-font text-blue-800 text-lg">វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</h2>
            <p class="font-bold text-gray-500">ប្រព័ន្ធត្រួតពិនិត្យលទ្ធផលសិក្សាសិស្ស</p>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-600">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">ជ្រើសរើសខែ/ឆមាស</label>
                    <select id="monthSelect" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm">
                        <option value="មករា">មករា</option><option value="កុម្ភៈ">កុម្ភៈ</option><option value="មីនា">មីនា</option>
                        <option value="មេសា">មេសា</option><option value="ឧសភា">ឧសភា</option><option value="មិថុនា">មិថុនា</option>
                        <option value="កក្កដា">កក្កដា</option><option value="សីហា">សីហា</option><option value="កញ្ញា">កញ្ញា</option>
                        <option value="តុលា">តុលា</option><option value="វិច្ឆិកា">វិច្ឆិកា</option><option value="ធ្នូ">ធ្នូ</option>
                        <option value="ប្រឡងឆមាសទី១">ប្រឡងឆមាសទី១</option><option value="ប្រឡងឆមាសទី២">ប្រឡងឆមាសទី២</option>
                        <option value="ប្រចាំឆមាសទី១">ប្រចាំឆមាសទី១</option><option value="ប្រចាំឆមាសទី២">ប្រចាំឆមាសទី២</option>
                        <option value="ប្រចាំឆ្នាំ">ប្រចាំឆ្នាំ</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">បញ្ចូលឈ្មោះ ឬ អត្តលេខ</label>
                    <div class="flex gap-2">
                        <input type="text" id="searchInput" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm" placeholder="ស្វែងរកទីនេះ...">
                        <button onclick="openScanner()" class="bg-blue-50 p-3 rounded-xl border border-blue-200 hover:bg-blue-100 text-blue-600 transition-all flex items-center justify-center shrink-0" title="ស្កេន QR Code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-end">
                    <button onclick="handleSearch()" id="searchBtn" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg">
                        <span>ឆែកមើលលទ្ធផល</span>
                        <div id="loader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center text-xs text-gray-400 font-bold tracking-widest">
            រក្សាសិទ្ធិគ្រប់យ៉ាង ២០២៦
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="capture-area" class="print-area hidden">
        
        <!-- Header -->
        <div class="text-center space-y-1">
            <h2 class="moul-font text-[13px] text-blue-900">ព្រះរាជាណាចក្រកម្ពុជា</h2>
            <h2 class="moul-font text-[13px] text-blue-900">ជាតិ សាសនា ព្រះមហាក្សត្រ</h2>
            <div class="flex justify-center items-center gap-1 opacity-30 mt-1">
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
                <div class="w-16 h-[1px] bg-blue-900"></div>
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
            </div>
        </div>

        <div class="mt-2 text-[11px] font-bold text-blue-900 leading-tight">
            <p>មន្ទីរអប់រំ យុវជន និងកីឡា ខេត្តកំពង់ឆ្នាំង</p>
            <p>ការិយាល័យអប់រំ យុវជន និងកីឡា ស្រុកកំពង់ត្រឡាច</p>
            <p>វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</p>
        </div>

        <h1 class="moul-font text-red-600 text-center text-xl mt-6 mb-4">តារាងលទ្ធផលសិក្សារបស់សិស្សប្រចាំ <span id="resMonth">...</span></h1>

        <!-- Student Basic Info -->
        <div class="grid grid-cols-2 gap-y-2 text-[13px] font-bold mt-2 px-4 border-l-4 border-blue-600 py-1">
            <p>គោត្តនាម-នាម ៖ <span id="resName" class="text-blue-800 moul-font ml-2">...</span></p>
            <p>ភេទ ៖ <span id="resGender" class="text-blue-800 ml-2">...</span></p>
            <p>ថ្ងៃខែឆ្នាំកំណើត ៖ <span id="resDOB" class="text-blue-800 ml-2">...</span></p>
            <p>ថ្នាក់ទី ៖ <span id="resGrade" class="text-blue-800 ml-2">...</span></p>
            <p>អត្តលេខ ៖ <span id="resId" class="text-blue-800 ml-2">...</span></p>
            <p>ឆ្នាំសិក្សា ៖ <span class="text-blue-800 ml-2">២០២៥-២០២៦</span></p>
        </div>

        <!-- Summary Statistics -->
        <div class="sketch-summary shadow-sm">
            <div class="sketch-item">
                <p class="sketch-label">មធ្យមភាគ</p>
                <p id="avgScore" class="sketch-value text-blue-600">0.00</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">ចំណាត់ថ្នាក់</p>
                <p id="rank" class="sketch-value text-red-500">0</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">និទ្ទេសរួម</p>
                <p id="gradeResult" class="sketch-value text-emerald-500">-</p>
            </div>
        </div>

        <!-- Scores Table -->
        <table>
            <thead>
                <tr>
                    <th class="w-10">ល.រ</th>
                    <th>មុខវិជ្ជា</th>
                    <th class="w-24">ពិន្ទុអតិបរមា</th>
                    <th class="w-24">ពិន្ទុទទួលបាន</th>
                    <th class="w-40">ក្រាបវិភាគ (%)</th>
                    <th class="w-16">និទ្ទេស</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="font-bold"></tbody>
            <tfoot>
                <tr class="bg-blue-50/50">
                    <td colspan="2" class="subject-col text-blue-900 uppercase">ពិន្ទុសរុប</td>
                    <td id="totalMax" class="font-black text-center text-gray-500">0</td>
                    <td id="totalScore" class="font-black text-center text-blue-700">0</td>
                    <td colspan="2" class="text-right pr-4 text-[11px] text-gray-400 italic">សមិទ្ធផលសិក្សាគិតជាភាគរយ</td>
                </tr>
            </tfoot>
        </table>

        <!-- Signature Section -->
        <div class="mt-8 flex justify-between items-start px-4">
            <div class="text-center">
                <p class="font-bold text-[11px]">បានឃើញ និងឯកភាព</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">នាយកសាលា</p>
                <div class="h-24"></div>
            </div>
            <div class="text-center">
                <p id="footerDate" class="text-[10px] text-gray-600">...</p>
                <p id="footerLunar" class="text-[10px] text-gray-500 mb-1">...</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">គ្រូបន្ទុកថ្នាក់</p>
                <div class="h-24"></div>
            </div>
        </div>
        
        <div class="text-center mt-10 text-[9px] text-gray-300 font-bold uppercase tracking-widest pb-4">
            រក្សាសិទ្ធិគ្រប់យ៉ាង ២០២៦
        </div>

        <!-- Bottom Action Buttons -->
        <div class="no-print mt-8 flex justify-center gap-4 border-t pt-8">
            <button onclick="downloadPDF()" class="bg-emerald-600 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">ទាញយក PDF</button>
            <button onclick="window.print()" class="bg-slate-800 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">បោះពុម្ព</button>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl p-4 max-w-sm w-full mx-4 shadow-2xl relative">
            <button onclick="closeScanner()" class="absolute -top-12 right-0 text-white hover:text-red-400 bg-white/20 p-2 rounded-full backdrop-blur-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h3 class="text-center font-bold text-gray-800 mb-4 moul-font text-sm">ស្កេន QR Code</h3>
            <div id="reader" class="w-full rounded-xl overflow-hidden bg-black min-h-[250px]"></div>
            <p class="text-xs text-center text-gray-500 mt-4">សូមដាក់កាមេរ៉ាឲ្យចំ QR Code ដើម្បីស្កេន</p>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl transform transition-all">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2" id="alertMessage">សាររំលឹក</h3>
                <button onclick="closeMessage()" class="mt-4 w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:text-sm">
                    យល់ព្រម
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzcf7w18kIFl2VkAdG0GeX9EoZqq-y1lDi8LyyA9gd1kVJfCsLsiGoUqv3xxmJM1qPQ/exec";
        const SUBJECTS = ["ភាសាខ្មែរ", "សីលធម៌ពលរដ្ឋ", "ប្រវត្តិវិទ្យា", "ភូមិវិទ្យា", "គណិតវិទ្យា", "រូបវិទ្យា", "គីមីវិទ្យា", "ជីវវិទ្យា", "ផែនដីវិទ្យា", "ភាសាអង់គ្លេស", "កីឡា", "កសិកម្ម", "បច្ចេកវិទ្យា", "បំណិន", "សុខភាព"];

        function getGrade(percent) {
            if (percent >= 90) return "A";
            if (percent >= 80) return "B";
            if (percent >= 70) return "C";
            if (percent >= 60) return "D";
            if (percent >= 50) return "E";
            return "F";
        }

        function getBarColor(percent) {
            if (percent >= 80) return "#10b981"; 
            if (percent >= 60) return "#3b82f6"; 
            if (percent >= 50) return "#f59e0b"; 
            return "#ef4444"; 
        }

        function showMessage(msg) {
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function closeMessage() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const month = document.getElementById('monthSelect').value;
            if (!query) return;

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('searchBtn').disabled = true;

            try {
                const [dataRes, configRes] = await Promise.all([
                    fetch(`${API_URL}?month=${encodeURIComponent(month)}`),
                    fetch(`${API_URL}?month=Config_MaxScores`)
                ]);
                
                const data = await dataRes.json();
                const config = await configRes.json();
                const s = data.find(i => i.ID?.toString().toLowerCase() === query || i.Name?.toString().toLowerCase().includes(query));

                if (s) {
                    const gradeConfig = config.find(c => c["កម្រិតថ្នាក់"]?.toString().trim() === s.Grade?.toString().trim());
                    
                    document.getElementById('resName').innerText = s.Name;
                    document.getElementById('resId').innerText = s.ID;
                    document.getElementById('resGrade').innerText = s.Grade;
                    document.getElementById('resGender').innerText = s.Gender || '...';
                    document.getElementById('resDOB').innerText = s.DOB || '...';
                    document.getElementById('resMonth').innerText = month;
                    document.getElementById('totalScore').innerText = s.Total;
                    document.getElementById('avgScore').innerText = s.Average;
                    document.getElementById('rank').innerText = s.Rank;
                    document.getElementById('gradeResult').innerText = s.Grade_Result;
                    document.getElementById('footerDate').innerText = s.DateSolar || '';
                    document.getElementById('footerLunar').innerText = s.DateLunar || '';

                    let tableHtml = "";
                    let totalMax = 0;

                    SUBJECTS.forEach((sub, idx) => {
                        const score = parseFloat(s[sub]);
                        const max = gradeConfig ? parseFloat(gradeConfig[sub]) : 50;
                        if (!isNaN(score)) {
                            totalMax += max;
                            const percent = Math.min((score / max) * 100, 100);
                            const grade = getGrade(percent);
                            const barColor = getBarColor(percent);
                            
                            tableHtml += `
                                <tr class="hover:bg-gray-50">
                                    <td class="text-gray-400 font-normal">${idx + 1}</td>
                                    <td class="subject-col">${sub}</td>
                                    <td class="text-gray-400">${max}</td>
                                    <td class="text-blue-700">${score}</td>
                                    <td class="px-3">
                                        <div class="flex items-center gap-2">
                                            <div class="progress-container">
                                                <div class="progress-bar" style="width: ${percent}%; background-color: ${barColor};"></div>
                                            </div>
                                            <span class="text-[9px] w-8 text-left text-gray-500">${Math.round(percent)}%</span>
                                        </div>
                                    </td>
                                    <td class="grade-${grade}">${grade}</td>
                                </tr>
                            `;
                        }
                    });

                    document.getElementById('tableBody').innerHTML = tableHtml;
                    document.getElementById('totalMax').innerText = totalMax;
                    document.getElementById('capture-area').classList.remove('hidden');
                } else {
                    showMessage("រកមិនឃើញទិន្នន័យ!");
                }
            } catch (e) {
                showMessage("មានបញ្ហាភ្ជាប់ទៅកាន់ Server!");
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        function downloadPDF() {
            const element = document.getElementById('capture-area');
            const name = document.getElementById('resName').innerText;
            const opt = {
                margin: 0,
                filename: `Result_${name}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 3, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // QR Code Scanner Logic
        let html5QrCode;

        function openScanner() {
            document.getElementById('qrModal').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            
            // Configuration for the scanner
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                showMessage("មិនអាចបើកកាមេរ៉ាបានទេ! សូមពិនិត្យមើលសិទ្ធិអនុញ្ញាត (Camera Permissions) របស់អ្នក។");
                closeScanner();
            });
        }

        function closeScanner() {
            document.getElementById('qrModal').classList.add('hidden');
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => {
                    console.log("Failed to stop scanner.", err);
                });
            }
        }

        function onScanSuccess(decodedText) {
            closeScanner(); // បិទកាមេរ៉ាវិញពេលស្កេនបានជោគជ័យ
            document.getElementById('searchInput').value = decodedText; // បញ្ចូលអត្ថបទដែលស្កេនបានទៅក្នុងប្រអប់ស្វែងរក
            handleSearch(); // ដំណើរការស្វែងរកដោយស្វ័យប្រវត្តិ
        }
    </script>
</body>
</html>
