<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធពិនិត្យលទ្ធផលសិក្សា - វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=Moul&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-blue: #1e40af;
            --khmer-red: #dc2626;
        }
        body { 
            font-family: 'Kantumruy Pro', sans-serif; 
            background: #f1f5f9;
            color: #1e293b;
        }
        .moul-font { font-family: 'Moul', serif; }
        
        .print-area {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 12mm 15mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* ថ្នាក់ថ្មីសម្រាប់ដោះស្រាយបញ្ហា PDF */
        .pdf-export-mode {
            margin: 0 !important;
            box-shadow: none !important;
            width: 210mm !important;
            height: 297mm !important; /* បង្ខំកម្ពស់ឱ្យប៉ុនក្រដាស A4 ចំ */
            overflow: hidden !important; /* កាត់ចោលផ្នែកដែលលើស */
            border-radius: 0 !important;
        }
        
        .sketch-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1.5px solid #e2e8f0;
            border-radius: 12px;
            margin: 20px 0;
            padding: 12px 0;
            background: #ffffff;
        }
        .sketch-item {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .sketch-item:not(:last-child)::after {
            content: "";
            position: absolute;
            right: 0;
            top: 10%;
            height: 80%;
            width: 1px;
            background-color: #e2e8f0;
        }
        .sketch-label {
            font-size: 11px;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .sketch-value {
            font-size: 22px;
            font-weight: 800;
        }

        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #cbd5e1; padding: 6px 4px; text-align: center; font-size: 12px; }
        th { background-color: #f8fafc; color: var(--primary-blue); font-weight: 700; height: 35px; }
        .subject-col { text-align: left; padding-left: 10px; font-weight: bold; font-size: 13px; width: 140px; }
        
        .progress-container {
            width: 100%;
            background-color: #f1f5f9;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-area { box-shadow: none; margin: 0; padding: 10mm; width: 100%; height: 297mm; }
        }
    </style>
</head>
<body>

    <!-- Search Section (Home Page Header) -->
    <div class="max-w-4xl mx-auto my-6 no-print px-4">
        <div class="text-center mb-6 space-y-2">
            <h2 class="moul-font text-blue-800 text-lg">វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</h2>
            <p class="font-bold text-gray-500">ប្រព័ន្ធត្រួតពិនិត្យលទ្ធផលសិក្សាសិស្ស</p>
        </div>
        
        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-600">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">ជ្រើសរើសខែ/ឆមាស</label>
                    <select id="monthSelect" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm">
                        <option value="មករា">មករា</option><option value="កុម្ភៈ">កុម្ភៈ</option><option value="មីនា">មីនា</option>
                        <option value="មេសា">មេសា</option><option value="ឧសភា">ឧសភា</option><option value="មិថុនា">មិថុនា</option>
                        <option value="កក្កដា">កក្កដា</option><option value="សីហា">សីហា</option><option value="កញ្ញា">កញ្ញា</option>
                        <option value="តុលា">តុលា</option><option value="វិច្ឆិកា">វិច្ឆិកា</option><option value="ធ្នូ">ធ្នូ</option>
                        <option value="ប្រឡងឆមាសទី១">ប្រឡងឆមាសទី១</option><option value="ប្រឡងឆមាសទី២">ប្រឡងឆមាសទី២</option>
                        <option value="ប្រចាំឆមាសទី១">ប្រចាំឆមាសទី១</option><option value="ប្រចាំឆមាសទី២">ប្រចាំឆមាសទី២</option>
                        <option value="ប្រចាំឆ្នាំ">ប្រចាំឆ្នាំ</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500">បញ្ចូលឈ្មោះ ឬ អត្តលេខ</label>
                    <div class="flex gap-2">
                        <input type="text" id="searchInput" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none font-bold text-sm" placeholder="ឧទាហរណ៍៖ កង វិច្ឆិកា ឬ 4250000551">
                        <button onclick="openScanner()" class="bg-blue-50 p-3 rounded-xl border border-blue-200 hover:bg-blue-100 text-blue-600 transition-all flex items-center justify-center shrink-0" title="ស្កេន QR Code">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-end">
                    <button onclick="handleSearch()" id="searchBtn" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg">
                        <span>ឆែកមើលលទ្ធផល</span>
                        <div id="loader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="capture-area" class="print-area hidden">
        
        <!-- Header -->
        <div class="text-center space-y-1">
            <h2 class="moul-font text-[13px] text-blue-900">ព្រះរាជាណាចក្រកម្ពុជា</h2>
            <h2 class="moul-font text-[13px] text-blue-900">ជាតិ សាសនា ព្រះមហាក្សត្រ</h2>
            <div class="flex justify-center items-center gap-1 opacity-30 mt-1">
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
                <div class="w-16 h-[1px] bg-blue-900"></div>
                <div class="w-2 h-2 rounded-full bg-blue-900"></div>
            </div>
        </div>

        <div class="mt-2 text-[11px] font-bold text-blue-900 leading-tight">
            <p>មន្ទីរអប់រំ យុវជន និងកីឡា ខេត្តកំពង់ឆ្នាំង</p>
            <p>ការិយាល័យអប់រំ យុវជន និងកីឡា ស្រុកកំពង់ត្រឡាច</p>
            <p>វិទ្យាល័យ ហ៊ុន សែន កំពង់ត្រឡាច</p>
        </div>

        <h1 class="moul-font text-red-600 text-center text-xl mt-6 mb-4">តារាងលទ្ធផលសិក្សារបស់សិស្សប្រចាំ <span id="resMonth">...</span></h1>

        <!-- Student Basic Info -->
        <div class="grid grid-cols-2 gap-y-2 text-[13px] font-bold mt-2 px-4 border-l-4 border-blue-600 py-1">
            <p>គោត្តនាម-នាម ៖ <span id="resName" class="text-blue-800 moul-font ml-2">...</span></p>
            <p>ភេទ ៖ <span id="resGender" class="text-blue-800 ml-2">...</span></p>
            <p>ថ្ងៃខែឆ្នាំកំណើត ៖ <span id="resDOB" class="text-blue-800 ml-2">...</span></p>
            <p>ថ្នាក់ទី ៖ <span id="resGrade" class="text-blue-800 ml-2">...</span></p>
            <p>អត្តលេខ ៖ <span id="resId" class="text-blue-800 ml-2">...</span></p>
            <p>ឆ្នាំសិក្សា ៖ <span id="resYear" class="text-blue-800 ml-2">...</span></p>
        </div>

        <!-- Summary Statistics -->
        <div class="sketch-summary shadow-sm">
            <div class="sketch-item">
                <p class="sketch-label">មធ្យមភាគ</p>
                <p id="avgScore" class="sketch-value text-blue-600">0.00</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">ចំណាត់ថ្នាក់</p>
                <p id="rank" class="sketch-value text-red-500">0</p>
            </div>
            <div class="sketch-item">
                <p class="sketch-label">និទ្ទេសរួម</p>
                <p id="gradeResult" class="sketch-value text-emerald-500">-</p>
            </div>
        </div>

        <!-- Scores Table -->
        <table>
            <thead>
                <tr>
                    <th class="w-10">ល.រ</th>
                    <th>មុខវិជ្ជា</th>
                    <th class="w-24">ពិន្ទុអតិបរមា</th>
                    <th class="w-24">ពិន្ទុទទួលបាន</th>
                    <th class="w-40">ក្រាបវិភាគ (%)</th>
                    <th class="w-16">និទ្ទេស</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="font-bold"></tbody>
            <tfoot>
                <tr class="bg-blue-50/50">
                    <td colspan="2" class="subject-col text-blue-900 uppercase">ពិន្ទុសរុប</td>
                    <td id="totalMax" class="font-black text-center text-gray-500">0</td>
                    <td id="totalScore" class="font-black text-center text-blue-700">0</td>
                    <td colspan="2" class="text-right pr-4 text-[11px] text-gray-400 italic">សមិទ្ធផលសិក្សា</td>
                </tr>
            </tfoot>
        </table>

        <!-- Signature Section -->
        <div class="mt-8 flex justify-between items-start px-4">
            <div class="text-center">
                <p class="font-bold text-[11px]">បានឃើញ និងឯកភាព</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">នាយកសាលា</p>
                <div class="h-24"></div>
            </div>
            <div class="text-center">
                <p id="footerDate" class="text-[10px] text-gray-600">...</p>
                <p id="footerLunar" class="text-[10px] text-gray-500 mb-1">...</p>
                <p class="moul-font text-[11px] text-blue-900 mt-1">គ្រូបន្ទុកថ្នាក់</p>
                <div class="h-24"></div>
            </div>
        </div>

        <!-- Bottom Action Buttons -->
        <div class="no-print mt-8 flex justify-center gap-4 border-t pt-8">
            <button onclick="downloadPDF()" class="bg-emerald-600 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">ទាញយក PDF</button>
            <button onclick="window.print()" class="bg-slate-800 text-white px-10 py-3 rounded-2xl font-bold shadow-lg hover:scale-105 transition-all">បោះពុម្ព</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2" id="alertMessage">សាររំលឹក</h3>
                <button onclick="closeMessage()" class="mt-4 w-full rounded-xl px-4 py-2 bg-blue-600 text-white font-bold hover:bg-blue-700">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl p-4 max-w-sm w-full mx-4 relative">
            <button onclick="closeScanner()" class="absolute -top-12 right-0 text-white bg-white/20 p-2 rounded-full">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h3 class="text-center font-bold text-gray-800 mb-4 moul-font text-sm">ស្កេន QR Code</h3>
            <div id="reader" class="w-full rounded-xl overflow-hidden bg-black min-h-[250px]"></div>
        </div>
    </div>

    <script>
        // API URL របស់អ្នក
        const API_URL = "https://script.google.com/macros/s/AKfycbzxwKIgU-HP92xFlY0TJGgDAUwp-EEAuzoEq7zn334uMnxODlAgsxBd-OE-lCwrp-sP/exec";
        
        // បញ្ជីមុខវិជ្ជាតាមលំដាប់ក្នុង Google Sheet
        const SUBJECTS = ["ភាសាខ្មែរ", "សីលធម៌ពលរដ្ឋ", "ប្រវត្តិវិទ្យា", "ភូមិវិទ្យា", "គណិតវិទ្យា", "រូបវិទ្យា", "គីមីវិទ្យា", "ជីវវិទ្យា", "ផែនដីវិទ្យា", "ភាសាអង់គ្លេស", "កីឡា", "កសិកម្ម", "បច្ចេកវិទ្យា", "បំណិន", "សុខភាព"];

        let html5QrcodeScanner = null;

        function getGrade(percent) {
            if (percent >= 90) return "A";
            if (percent >= 80) return "B";
            if (percent >= 70) return "C";
            if (percent >= 60) return "D";
            if (percent >= 50) return "E";
            return "F";
        }

        function getBarColor(percent) {
            if (percent >= 80) return "#10b981"; 
            if (percent >= 60) return "#3b82f6"; 
            if (percent >= 50) return "#f59e0b"; 
            return "#ef4444"; 
        }

        function showMessage(msg) {
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('alertModal').classList.remove('hidden');
        }
        function closeMessage() { document.getElementById('alertModal').classList.add('hidden'); }

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const month = document.getElementById('monthSelect').value;
            
            if (!query) {
                showMessage("សូមបញ្ចូលឈ្មោះ ឬ អត្តលេខសិស្ស!");
                return;
            }

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('capture-area').classList.add('hidden');

            try {
                // ទាញយកទិន្នន័យពី API របស់អ្នក
                const dataRes = await fetch(`${API_URL}?month=${encodeURIComponent(month)}`);
                const data = await dataRes.json();
                
                // ត្រងយកសិស្សដែលមាន ID និងស្វែងរកសិស្ស
                const s = data.find(i => 
                    i.ID && i.ID.toString().trim() !== "" && i.ID !== "#REF!" &&
                    (i.ID.toString().toLowerCase() === query || 
                    (i.Name && i.Name.toString().toLowerCase().includes(query)))
                );

                if (s) {
                    // បង្ហាញព័ត៌មានសិស្ស
                    document.getElementById('resMonth').innerText = month;
                    document.getElementById('resName').innerText = s.Name || "";
                    document.getElementById('resId').innerText = s.ID || "";
                    document.getElementById('resGrade').innerText = s.Grade || "";
                    document.getElementById('resGender').innerText = s.Gender || "";
                    document.getElementById('resDOB').innerText = s.DOB || "";
                    document.getElementById('resYear').innerText = s.AcademicYear || "២០២៤-២០២៥";
                    
                    document.getElementById('avgScore').innerText = Number(s.Average || 0).toFixed(2);
                    document.getElementById('rank').innerText = s.Rank || "-";
                    document.getElementById('gradeResult').innerText = s.Grade_Result || "-";
                    
                    document.getElementById('totalScore').innerText = Number(s.Total || 0).toFixed(2);
                    
                    document.getElementById('footerDate').innerText = s.DateSolar || "ថ្ងៃទី.......ខែ.......ឆ្នាំ២០២...";
                    document.getElementById('footerLunar').innerText = s.DateLunar || "";

                    // បង្កើតតារាងពិន្ទុ
                    let tbody = '';
                    let sumMax = 0;
                    let i = 1;

                    SUBJECTS.forEach(sub => {
                        let rawScore = s[sub];
                        // ប្រសិនបើកោសិកានោះទទេរ កុំបង្ហាញមុខវិជ្ជានោះ
                        if (rawScore !== undefined && rawScore !== "" && rawScore !== "#REF!") {
                            let score = Number(rawScore) || 0;
                            // កំណត់ពិន្ទុអតិបរមាស្តង់ដារ (50 សម្រាប់មុខវិជ្ជាភាគច្រើន, កែប្រែតាមការជាក់ស្តែងរបស់អ្នក)
                            let max = (sub === 'កីឡា' || sub === 'កសិកម្ម') ? 50 : 50; 
                            sumMax += max;
                            
                            let percent = max > 0 ? (score / max) * 100 : 0;
                            let grade = getGrade(percent);
                            let barColor = getBarColor(percent);

                            tbody += `
                                <tr>
                                    <td class="text-gray-500">${i++}</td>
                                    <td class="subject-col">${sub}</td>
                                    <td class="text-gray-600">${max}</td>
                                    <td class="text-blue-600 font-bold">${score.toFixed(2)}</td>
                                    <td class="px-2">
                                        <div class="flex items-center gap-2">
                                            <div class="progress-container">
                                                <div class="progress-bar" style="width: ${percent}%; background-color: ${barColor}"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="font-black" style="color: ${barColor}">${grade}</td>
                                </tr>`;
                        }
                    });

                    document.getElementById('tableBody').innerHTML = tbody;
                    document.getElementById('totalMax').innerText = sumMax;
                    document.getElementById('capture-area').classList.remove('hidden');
                } else {
                    showMessage(`រកមិនឃើញសិស្សឈ្មោះ "${query}" ក្នុងខែ ${month} ទេ! សូមពិនិត្យមើលការសរសេរឡើងវិញ។`);
                }
            } catch (err) {
                console.error(err);
                showMessage("មានបញ្ហាក្នុងការភ្ជាប់ទៅកាន់ប្រព័ន្ធទិន្នន័យ។ សូមព្យាយាមម្តងទៀត។");
            } finally {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // អនុញ្ញាតឲ្យចុច Enter ដើម្បីស្វែងរក
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleSearch();
        });

        // មុខងារស្កេន QR Code
        function openScanner() {
            document.getElementById('qrModal').classList.remove('hidden');
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            }
        }

        function closeScanner() {
            document.getElementById('qrModal').classList.add('hidden');
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }
        }

        function onScanSuccess(decodedText) {
            closeScanner();
            document.getElementById('searchInput').value = decodedText;
            handleSearch();
        }
        function onScanFailure(error) {}

        // មុខងារទាញយក PDF បានកែសម្រួលដើម្បីឱ្យពេញមួយទំព័រ A4
        function downloadPDF() {
            const element = document.getElementById('capture-area');
            const studentName = document.getElementById('resName').innerText;
            const month = document.getElementById('resMonth').innerText;
            
            // បន្ថែម Class ដើម្បីកាត់ Margin និងបង្ខំទំហំ A4 មុនពេលទាញយក
            element.classList.add('pdf-export-mode');
            
            const opt = {
                margin: 0, 
                filename: `លទ្ធផលសិក្សា_${studentName}_${month}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 2, // បង្កើនភាពច្បាស់
                    useCORS: true,
                    scrollY: 0, // ជួសជុលបញ្ហាសល់ចន្លោះសធំខាងលើ
                    windowWidth: 800 // ការពារកុំឱ្យខូចទម្រង់ពេលទាញយកតាមទូរស័ព្ទ
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // ដក Class នោះចេញវិញ ក្រោយពេល Save រួច
                element.classList.remove('pdf-export-mode');
            });
        }
    </script>
</body>
</html>
